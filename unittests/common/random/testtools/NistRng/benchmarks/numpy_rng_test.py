#
# Copyright (C) 2019 Luca Pasqualini
# University of Siena - Artificial Intelligence Laboratory - SAILab
#
# Inspired by the work of David Johnston (C) 2017: https://github.com/dj-on-github/sp800_22_tests
#
# NistRng is licensed under a BSD 3-Clause.
#
# You should have received a copy of the license along with this
# work. If not, see <https://opensource.org/licenses/BSD-3-Clause>.

# Import packages

# TODO setup numpy scipy cppyy

import numpy
import random

# Import src

import sys
sys.path.insert(0, "/home/forrest/code/ym/unittests/common/random/testtools/NistRng/")

from nistrng import *

import cppyy

if __name__ == "__main__":
    # Generate the sequence of integers and pack it in its 8-bit representation
    # sequence: numpy.ndarray = numpy.random.randint(-128, 128, 1000, dtype=int)
    # binary_sequence: numpy.ndarray = pack_sequence(sequence)

    cppyy.add_include_path("/home/forrest/code/ym/common/")
    cppyy.include("random.h")
    cppyy.add_library_path("/home/forrest/code/ym/common/")
    cppyy.load_library("librandom.so")
    rand = cppyy.gbl.ym.Random()

    n = 10000
    sequence = numpy.zeros(n*4, dtype=numpy.uint8)
    for i in range(n):
        r = rand.gen[cppyy.gbl.ym.uint32]()
        sequence[i*4 + 0] = r >> 24
        sequence[i*4 + 1] = r >> 16
        sequence[i*4 + 2] = r >> 8
        sequence[i*4 + 3] = r >> 0

    binary_sequence = numpy.unpackbits(sequence).astype(numpy.int8)

    # Print sequence
    # print("Random sequence generated by NumPy:")
    # print(sequence)
    # print("Random sequence generated by NumPy encoded in 8-bit signed format:")
    # print(binary_sequence)
    # print("Original sequence taken back by unpacking (to check the correctness of packing process:")
    # print(unpack_sequence(binary_sequence))
    # Check the eligibility of the test and generate an eligible battery from the default NIST-sp800-22r1a battery
    eligible_battery: dict = check_eligibility_all_battery(binary_sequence, SP800_22R1A_BATTERY)
    # Print the eligible tests
    print("Eligible test from NIST-SP800-22r1a:")
    for name in eligible_battery.keys():
        print("-" + name)
    # Test the sequence on the eligible tests
    results = run_all_battery(binary_sequence, eligible_battery, False)
    # Print results one by one
    print("Test results:")
    for result, elapsed_time in results:
        if result.passed:
            print("- PASSED - score: " + str(numpy.round(result.score, 3)) + " - " + result.name + " - elapsed time: " + str(elapsed_time) + " ms")
        else:
            print("- FAILED - score: " + str(numpy.round(result.score, 3)) + " - " + result.name + " - elapsed time: " + str(elapsed_time) + " ms")
